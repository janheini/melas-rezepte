---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getEntry } from "astro:content";
import NewRecipe from "@/components/NewRecipe.vue";
import ConfirmDeleteDialog from "@/components/ConfirmDeleteDialog.vue";
import {
    deleteRecipe,
    changeRecipe,
    createValidFilename,
    trimRecipe,
    createContent,
    createNewRecipe,
} from "@/lib/utils";

const session = await Astro.locals.auth.validate();
if (!session) return Astro.redirect("/login", 302);

const slug = Astro.params.slug;

if (!slug) {
    return new Response(null, {
        status: 404,
        statusText: "Not found",
    });
}

const post = await getEntry("rezepte", slug);

if (!post) {
    return new Response(null, {
        status: 404,
        statusText: "Not found",
    });
}

if (Astro.request.method === "POST") {
    const recipe = trimRecipe(await Astro.request.json());
    const filename = `${slug}.md`;
    const newFilename = createValidFilename(recipe.title);
    const content = createContent(recipe);

    if (filename === newFilename) {
        const result = await changeRecipe(filename, recipe.title, content);
        console.log(`Result of changing recipe:\n${JSON.stringify(result)}`);
    } else {
        const deleteResult = await deleteRecipe(filename);
        console.log(
            `Result of deleting old recipe:\n${JSON.stringify(deleteResult)}`,
        );
        const createResult = await createNewRecipe(
            newFilename,
            recipe.title,
            content,
        );
        console.log(
            `Result of creating new recipe:\n${JSON.stringify(createResult)}`,
        );
    }

    // if (result.status == 200) {
    //     return Astro.redirect(".");
    // }

    return new Response();
}

if (Astro.request.method === "DELETE") {
    return new Response(await deleteRecipe(`${slug}.md`));
}
---

<BaseLayout>
    <div class="prose grid max-w-md gap-4 dark:prose-invert">
        <NewRecipe recipe={post} client:load />
        <ConfirmDeleteDialog client:only />
    </div>
</BaseLayout>
