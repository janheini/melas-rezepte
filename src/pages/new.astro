---
import BaseLayout from "../layouts/BaseLayout.astro";
import NewRecipe from "@/components/NewRecipe.vue";
import {
    createValidFilename,
    trimRecipe,
    createContent,
    createNewRecipe,
} from "@/lib/utils";

const session = await Astro.locals.auth.validate();
if (!session) return Astro.redirect("/login", 302);

if (Astro.request.method === "POST") {
    const recipe = trimRecipe(await Astro.request.json());
    const filename = createValidFilename(recipe.title);
    const content = createContent(recipe);
    const result = await createNewRecipe(filename, recipe.title, content);

    // if (result.status == 201) {
    //     return Astro.redirect(".");
    // }

    console.log(result);
    return new Response(JSON.stringify(result));
}
---

<BaseLayout>
    <div class="prose grid max-w-md gap-4 dark:prose-invert">
        <NewRecipe client:load />
    </div>
</BaseLayout>
