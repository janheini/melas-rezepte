---
import BaseLayout from "../layouts/BaseLayout.astro";
import { tags } from "../content/config.ts";
import { request } from "@octokit/request";
import NewRecipe from "@/components/NewRecipe.vue";
import { z } from "astro:content";

type IngredientList = {
    title: string;
    ingredients: Array<string>;
};

export type Recipe = {
    title: string;
    tagList: Array<z.infer<typeof tags>>;
    ingredientList: Array<IngredientList>;
    instructions: string;
};

const session = await Astro.locals.auth.validate();
if (!session) return Astro.redirect("/login", 302);

function createValidFilename(str: string) {
    str =
        str
            .replace(/[\/\\:*?"<>|]/g, "_") // Replace invalid characters with underscores
            .replace(/\s+/g, "_") // Replace spaces with underscores
            .replace(/^\s+|\s+$/g, "") // Remove leading/trailing spaces
            .toLowerCase() + ".md"; // add markdown extension

    if (str.length > 255) {
        return str.slice(0, 255);
    }
    return str;
}

if (Astro.request.method === "POST") {
    const recipe = (await Astro.request.json()) as Recipe;

    recipe.title = recipe.title.trim();
    for (const ingredientList of recipe.ingredientList) {
        ingredientList.title = ingredientList.title.trim();
        ingredientList.ingredients = ingredientList.ingredients
            .map((ingredient) => ingredient.trim())
            .filter((ingredient) => ingredient.length > 0);
    }
    recipe.instructions = recipe.instructions.trim();
    const filename = createValidFilename(recipe.title);
    const path = `src/content/rezepte/${filename}`;
    const content = `
---
${JSON.stringify({
    title: recipe.title,
    tags: recipe.tagList,
    ingredientList: recipe.ingredientList,
})}
---
${recipe.instructions}
`.trim();

    console.log(content);
    const result = await request(
        `PUT /repos/janheini/melas-rezepte/contents/${path}`,
        {
            owner: "janheini",
            repo: "melas-rezepte",
            path: path,
            message: `added recipe ${recipe.title}`,
            content: Buffer.from(content, "utf8").toString("base64"),
            headers: {
                "X-GitHub-Api-Version": "2022-11-28",
                authorization: `token ${import.meta.env.GITHUB_TOKEN}`,
            },
        },
    );

    // if (result.status == 201) {
    //     return Astro.redirect(".");
    // }

    console.log(result);
    return new Response(JSON.stringify(result));
}
---

<BaseLayout>
    <NewRecipe client:load />
</BaseLayout>
